name: Deploy Cluster

on:
  workflow_call:
    inputs:
      cluster_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      available_zones:
        required: true
        type: string
      worker_nodes:
        required: false
        type: string
        default: '2'
      worker_size:
        required: false
        type: string
        default: 't2.small'
      master_size:
        required: false
        type: string
        default: 't2.medium'
      master_nodes:
        required: false
        type: string
        default: '1'
      event_name:
        required: true
        type: string

jobs:
  deploy:
    name: Deploy kOps Cluster
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install kOps and kubectl
        run: |
          KOPS_VERSION=$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl -Lo kops "https://github.com/kubernetes/kops/releases/download/${KOPS_VERSION}/kops-linux-amd64"
          chmod +x kops && sudo mv kops /usr/local/bin/
          
          KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          echo "âœ… Tools installed"

      - name: SSH Key Setup
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          echo "âœ… SSH key setup completed"

      - name: Check Cluster Existence
        run: |
          KOPS_STATE_STORE="s3://${{ vars.TF_STATE_BUCKET }}/${{ inputs.environment }}/clusters/"
          echo "KOPS_STATE_STORE=$KOPS_STATE_STORE" >> $GITHUB_ENV
          echo "CLUSTER_NAME=${{ inputs.cluster_name }}" >> $GITHUB_ENV
          
          if kops get cluster --name=${{ inputs.cluster_name }} --state=$KOPS_STATE_STORE >/dev/null 2>&1; then
            echo "âš ï¸  Cluster exists"
            echo "CLUSTER_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âœ… Creating new cluster"
            echo "CLUSTER_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Create Cluster
        if: ${{ env.CLUSTER_EXISTS == 'false' }}
        run: |
          kops create sshpublickey ${{ inputs.cluster_name }} -i ~/.ssh/id_rsa.pub --state=$KOPS_STATE_STORE
          
          kops create cluster \
            --name=${{ inputs.cluster_name }} \
            --state=$KOPS_STATE_STORE \
            --zones=${{ inputs.available_zones }} \
            --node-count="${{ inputs.worker_nodes }}" \
            --node-size="${{ inputs.worker_size }}" \
            --master-size="${{ inputs.master_size }}" \
            --master-count="${{ inputs.master_nodes }}" \
            --networking=calico \
            --dns-zone=${{ inputs.cluster_name }} \
            --ssh-public-key="~/.ssh/id_rsa.pub"
          echo "âœ… Cluster configuration created"

      - name: Generate Terraform Files
        run: |
          kops update cluster \
            --name=${{ inputs.cluster_name }} \
            --state=$KOPS_STATE_STORE \
            --yes --admin \
            --out ./kops-infra \
            --target terraform
          echo "âœ… Terraform files generated"

      - name: Deploy Infrastructure
        working-directory: ./kops-infra
        run: |
          cat > backend.tf << EOF
          terraform {
            backend "s3" {
              bucket = "${{ vars.TF_STATE_BUCKET }}"
              key    = "${{ inputs.environment }}/kops-infra/${{ inputs.cluster_name }}"
              region = "${{ vars.AWS_REGION }}"
            }
          }
          EOF
          
          terraform init
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure deployed"

      - name: Validate Cluster
        run: |
          kops export kubeconfig --name="${{ inputs.cluster_name }}" --state="$KOPS_STATE_STORE" --admin
          kops validate cluster --name="${{ inputs.cluster_name }}" --state="$KOPS_STATE_STORE" --wait=10m
          
          kubectl get nodes
          kubectl get namespaces
          
          # Share kubeconfig and SSH keys
          S3_PATH="s3://${{ vars.TF_STATE_BUCKET }}/${{ inputs.environment }}/${{ inputs.cluster_name }}"
          aws s3 cp ~/.kube/config "$S3_PATH/kubeconfig"
          aws s3 cp ~/.ssh/id_rsa "$S3_PATH/ssh-key"
          aws s3 cp ~/.ssh/id_rsa.pub "$S3_PATH/ssh-key.pub"
          
          echo "âœ… Cluster ready and access files shared"
          echo "ğŸ“‹ Cluster: ${{ inputs.cluster_name }}"
          echo "ğŸ”— Kubeconfig: aws s3 cp $S3_PATH/kubeconfig ~/.kube/config"
          echo "ğŸ” SSH Key: aws s3 cp $S3_PATH/ssh-key ~/.ssh/${{ inputs.cluster_name }}-key && chmod 600 ~/.ssh/${{ inputs.cluster_name }}-key"
          echo "ğŸ”‘ SSH Usage: ssh -i ~/.ssh/${{ inputs.cluster_name }}-key ubuntu@<node-ip>"
